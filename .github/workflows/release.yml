name: TimeTask Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    env:
      Main_Project_Path: TimeTask.csproj
      Build_Configuration: Release
      Build_Platform: AnyCPU
      Artifact_Name: TimeTask-win-x64.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v2

      - name: Restore
        run: msbuild $env:Main_Project_Path /t:Restore /p:Configuration=$env:Build_Configuration /p:Platform=$env:Build_Platform

      - name: Build
        run: msbuild $env:Main_Project_Path /p:Configuration=$env:Build_Configuration /p:Platform=$env:Build_Platform /m

      - name: Package app
        shell: pwsh
        run: |
          $outputDir = Join-Path $env:GITHUB_WORKSPACE "bin\Release"
          if (-not (Test-Path (Join-Path $outputDir "TimeTask.exe"))) {
            throw "TimeTask.exe not found in $outputDir"
          }

          $stagingDir = Join-Path $env:RUNNER_TEMP "TimeTask"
          New-Item -ItemType Directory -Path $stagingDir -Force | Out-Null
          Copy-Item -Path (Join-Path $outputDir "*") -Destination $stagingDir -Recurse -Force

          $zipPath = Join-Path $env:GITHUB_WORKSPACE $env:Artifact_Name
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $stagingDir "*") -DestinationPath $zipPath -Force

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: TimeTask-win-x64.zip
          generate_release_notes: true
